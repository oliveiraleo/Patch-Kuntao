From dbc4c2d96c606795ef9752775617e1f22b7379bb Mon Sep 17 00:00:00 2001
From: Vladimir Oltean <olteanv@gmail.com>
Date: Mon, 8 Apr 2024 13:35:27 +0300
Subject: [PATCH] =?UTF-8?q?Fix=20storaged=20access=20to=20/sys/block/mmcbl?=
 =?UTF-8?q?k0/stat=20after=C2=A048027a0?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

---
 prebuilts/api/34.0/private/compat/33.0/33.0.ignore.cil | 1 +
 prebuilts/api/34.0/private/storaged.te                 | 5 +++++
 prebuilts/api/34.0/public/file.te                      | 1 +
 private/compat/33.0/33.0.ignore.cil                    | 1 +
 private/storaged.te                                    | 5 +++++
 public/file.te                                         | 1 +
 6 files changed, 14 insertions(+)

diff --git a/prebuilts/api/34.0/private/compat/33.0/33.0.ignore.cil b/prebuilts/api/34.0/private/compat/33.0/33.0.ignore.cil
index 3c92b45a66..710d3b32d2 100644
--- a/prebuilts/api/34.0/private/compat/33.0/33.0.ignore.cil
+++ b/prebuilts/api/34.0/private/compat/33.0/33.0.ignore.cil
@@ -64,6 +64,7 @@
     servicemanager_prop
     shutdown_checkpoints_system_data_file
     stats_config_data_file
+    sysfs_disk_stat
     sysfs_fs_fuse_features
     system_net_netd_service
     timezone_metadata_prop
diff --git a/prebuilts/api/34.0/private/storaged.te b/prebuilts/api/34.0/private/storaged.te
index bb39e5b73f..8b6beed362 100644
--- a/prebuilts/api/34.0/private/storaged.te
+++ b/prebuilts/api/34.0/private/storaged.te
@@ -7,6 +7,11 @@ init_daemon_domain(storaged)
 # Read access to pseudo filesystems
 r_dir_file(storaged, domain)
 
+# Allow read access to /sys/block/mmcblk0/stat or /sys/block/sda/stat.
+# Implementations typically have symlinks to vendor specific files.
+# Vendors should mark sysfs_disk_stat on all files read by storaged.
+r_dir_file(storaged, sysfs_disk_stat)
+
 # Read /proc/uid_io/stats
 allow storaged proc_uid_io_stats:file r_file_perms;
 
diff --git a/prebuilts/api/34.0/public/file.te b/prebuilts/api/34.0/public/file.te
index 0ce5c34363..be25bcc3d8 100644
--- a/prebuilts/api/34.0/public/file.te
+++ b/prebuilts/api/34.0/public/file.te
@@ -17,6 +17,7 @@ type proc_min_free_order_shift, fs_type, proc_type;
 type proc_kpageflags, fs_type, proc_type;
 type proc_watermark_boost_factor, fs_type, proc_type;
 # proc, sysfs, or other nodes that permit configuration of kernel usermodehelpers.
+type sysfs_disk_stat, fs_type, sysfs_type;
 type usermodehelper, fs_type, proc_type;
 type sysfs_usermodehelper, fs_type, sysfs_type;
 type proc_qtaguid_ctrl, fs_type, mlstrustedobject, proc_type;
diff --git a/private/compat/33.0/33.0.ignore.cil b/private/compat/33.0/33.0.ignore.cil
index 0d67f20ed8..ad81630096 100644
--- a/private/compat/33.0/33.0.ignore.cil
+++ b/private/compat/33.0/33.0.ignore.cil
@@ -70,6 +70,7 @@
     shutdown_checkpoints_system_data_file
     snapuserd_log_data_file
     stats_config_data_file
+    sysfs_disk_stat
     sysfs_fs_fuse_features
     system_net_netd_service
     timezone_metadata_prop
diff --git a/private/storaged.te b/private/storaged.te
index bb39e5b73f..8b6beed362 100644
--- a/private/storaged.te
+++ b/private/storaged.te
@@ -7,6 +7,11 @@ init_daemon_domain(storaged)
 # Read access to pseudo filesystems
 r_dir_file(storaged, domain)
 
+# Allow read access to /sys/block/mmcblk0/stat or /sys/block/sda/stat.
+# Implementations typically have symlinks to vendor specific files.
+# Vendors should mark sysfs_disk_stat on all files read by storaged.
+r_dir_file(storaged, sysfs_disk_stat)
+
 # Read /proc/uid_io/stats
 allow storaged proc_uid_io_stats:file r_file_perms;
 
diff --git a/public/file.te b/public/file.te
index 01143f739a..fbd38cfd79 100644
--- a/public/file.te
+++ b/public/file.te
@@ -19,6 +19,7 @@ type proc_watermark_boost_factor, fs_type, proc_type;
 type proc_percpu_pagelist_high_fraction, fs_type, proc_type;
 # proc, sysfs, or other nodes that permit configuration of kernel usermodehelpers.
 type usermodehelper, fs_type, proc_type;
+type sysfs_disk_stat, fs_type, sysfs_type;
 type sysfs_usermodehelper, fs_type, sysfs_type;
 type proc_qtaguid_ctrl, fs_type, mlstrustedobject, proc_type;
 type proc_qtaguid_stat, fs_type, mlstrustedobject, proc_type;
