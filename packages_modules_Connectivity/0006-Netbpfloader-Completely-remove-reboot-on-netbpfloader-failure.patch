From 9e6a60419de74ad885a62167aa3b4051cf2fed46 Mon Sep 17 00:00:00 2001
From: Aryan Sinha <sinha.aryan03@gmail.com>
Date: Sun, 14 Apr 2024 05:59:19 +0300
Subject: [PATCH] netbpfloader: Completely remove reboot on netbpfloader
 failure

* Fixes Booting on 4.4 & below
---
 netbpfload/initrc-doc/bpfloader-sdk30-11-R.rc              | 1 -
 netbpfload/initrc-doc/bpfloader-sdk31-12-S.rc              | 1 -
 netbpfload/initrc-doc/bpfloader-sdk33-13-T.rc              | 1 -
 netbpfload/initrc-doc/bpfloader-sdk34-14-U-QPR2.rc         | 1 -
 netbpfload/initrc-doc/bpfloader-sdk34-14-U.rc              | 1 -
 netbpfload/netbpfload.rc                                   | 1 -
 service/src/com/android/server/BpfLoaderRcUtils.java       | 3 ---
 tests/unit/java/com/android/server/BpfLoaderRcUtilsTest.kt | 2 --
 8 files changed, 11 deletions(-)

diff --git a/netbpfload/initrc-doc/bpfloader-sdk30-11-R.rc b/netbpfload/initrc-doc/bpfloader-sdk30-11-R.rc
index 482a7db95b..e86cf2a642 100644
--- a/netbpfload/initrc-doc/bpfloader-sdk30-11-R.rc
+++ b/netbpfload/initrc-doc/bpfloader-sdk30-11-R.rc
@@ -7,5 +7,4 @@ service bpfloader /system/bin/bpfloader
     capabilities CHOWN SYS_ADMIN
     rlimit memlock 1073741824 1073741824
     oneshot
-    reboot_on_failure reboot,bpfloader-failed
     updatable
diff --git a/netbpfload/initrc-doc/bpfloader-sdk31-12-S.rc b/netbpfload/initrc-doc/bpfloader-sdk31-12-S.rc
index 411788775a..0f6e8cb680 100644
--- a/netbpfload/initrc-doc/bpfloader-sdk31-12-S.rc
+++ b/netbpfload/initrc-doc/bpfloader-sdk31-12-S.rc
@@ -7,5 +7,4 @@ service bpfloader /system/bin/bpfloader
     capabilities CHOWN SYS_ADMIN NET_ADMIN
     rlimit memlock 1073741824 1073741824
     oneshot
-    reboot_on_failure reboot,bpfloader-failed
     updatable
diff --git a/netbpfload/initrc-doc/bpfloader-sdk33-13-T.rc b/netbpfload/initrc-doc/bpfloader-sdk33-13-T.rc
index f0b6700c74..256476124c 100644
--- a/netbpfload/initrc-doc/bpfloader-sdk33-13-T.rc
+++ b/netbpfload/initrc-doc/bpfloader-sdk33-13-T.rc
@@ -8,5 +8,4 @@ service bpfloader /system/bin/bpfloader
     capabilities CHOWN SYS_ADMIN NET_ADMIN
     rlimit memlock 1073741824 1073741824
     oneshot
-    reboot_on_failure reboot,bpfloader-failed
     updatable
diff --git a/netbpfload/initrc-doc/bpfloader-sdk34-14-U-QPR2.rc b/netbpfload/initrc-doc/bpfloader-sdk34-14-U-QPR2.rc
index 8f3f462eb8..0018200d30 100644
--- a/netbpfload/initrc-doc/bpfloader-sdk34-14-U-QPR2.rc
+++ b/netbpfload/initrc-doc/bpfloader-sdk34-14-U-QPR2.rc
@@ -7,5 +7,4 @@ service bpfloader /system/bin/netbpfload
     user root
     rlimit memlock 1073741824 1073741824
     oneshot
-    reboot_on_failure reboot,bpfloader-failed
     updatable
diff --git a/netbpfload/initrc-doc/bpfloader-sdk34-14-U.rc b/netbpfload/initrc-doc/bpfloader-sdk34-14-U.rc
index 592303ef87..71ab24c200 100644
--- a/netbpfload/initrc-doc/bpfloader-sdk34-14-U.rc
+++ b/netbpfload/initrc-doc/bpfloader-sdk34-14-U.rc
@@ -7,5 +7,4 @@ service bpfloader /system/bin/bpfloader
     user root
     rlimit memlock 1073741824 1073741824
     oneshot
-    reboot_on_failure reboot,bpfloader-failed
     updatable
diff --git a/netbpfload/netbpfload.rc b/netbpfload/netbpfload.rc
index 14181dc6fc..94024e367e 100644
--- a/netbpfload/netbpfload.rc
+++ b/netbpfload/netbpfload.rc
@@ -81,6 +81,5 @@ service bpfloader /system/bin/netbpfload
     #    'cannot prove return value is 0 or 1' or 'unsupported / unknown operation / helper',
     #    'invalid bpf_context access', etc.
     #
-    reboot_on_failure reboot,bpfloader-failed
     # we're not really updatable, but want to be able to load bpf programs shipped in apexes
     updatable
diff --git a/service/src/com/android/server/BpfLoaderRcUtils.java b/service/src/com/android/server/BpfLoaderRcUtils.java
index 293e757c72..4b547a2c83 100644
--- a/service/src/com/android/server/BpfLoaderRcUtils.java
+++ b/service/src/com/android/server/BpfLoaderRcUtils.java
@@ -46,7 +46,6 @@ public class BpfLoaderRcUtils {
             "capabilities CHOWN SYS_ADMIN NET_ADMIN",
             "rlimit memlock 1073741824 1073741824",
             "oneshot",
-            "reboot_on_failure reboot,bpfloader-failed",
             "updatable"
     );
 
@@ -57,7 +56,6 @@ public class BpfLoaderRcUtils {
             "user root",
             "rlimit memlock 1073741824 1073741824",
             "oneshot",
-            "reboot_on_failure reboot,bpfloader-failed",
             "updatable"
     );
 
@@ -68,7 +66,6 @@ public class BpfLoaderRcUtils {
             "user root",
             "rlimit memlock 1073741824 1073741824",
             "oneshot",
-            "reboot_on_failure reboot,bpfloader-failed",
             "updatable"
     );
 
diff --git a/tests/unit/java/com/android/server/BpfLoaderRcUtilsTest.kt b/tests/unit/java/com/android/server/BpfLoaderRcUtilsTest.kt
index 2cf6b178d1..5d7679fb60 100644
--- a/tests/unit/java/com/android/server/BpfLoaderRcUtilsTest.kt
+++ b/tests/unit/java/com/android/server/BpfLoaderRcUtilsTest.kt
@@ -42,7 +42,6 @@ class BpfLoaderRcUtilsTest {
                 rlimit memlock 1073741824 1073741824
                 oneshot
                 # comment 漢字
-                reboot_on_failure reboot,bpfloader-failed
                 updatable
             
             #test comment
@@ -57,7 +56,6 @@ class BpfLoaderRcUtilsTest {
             "user root",
             "rlimit memlock 1073741824 1073741824",
             "oneshot",
-            "reboot_on_failure reboot,bpfloader-failed",
             "updatable"
         )
 
