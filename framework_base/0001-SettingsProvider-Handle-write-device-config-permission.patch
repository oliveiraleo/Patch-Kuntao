From 443dfab86fe6da4b10b5ea3be8a37e777d5bef39 Mon Sep 17 00:00:00 2001
From: Murat Kozan <muratkozan350@gmail.com>
Date: Sun, 31 Mar 2024 09:00:58 +0300
Subject: [PATCH] SettingsProvider: Handle WRITE_DEVICE_CONFIG permission
 denial for gms

---
 .../providers/settings/SettingsProvider.java  | 20 +++++++++++++++----
 1 file changed, 16 insertions(+), 4 deletions(-)

diff --git a/packages/SettingsProvider/src/com/android/providers/settings/SettingsProvider.java b/packages/SettingsProvider/src/com/android/providers/settings/SettingsProvider.java
index 32e6b3d58670..fe4f6395210f 100644
--- a/packages/SettingsProvider/src/com/android/providers/settings/SettingsProvider.java
+++ b/packages/SettingsProvider/src/com/android/providers/settings/SettingsProvider.java
@@ -1156,8 +1156,8 @@ private boolean insertConfigSetting(String name, String value, boolean makeDefau
             Slog.v(LOG_TAG, "setAllConfigSettings for prefix: " + prefix);
         }
 
-        enforceWritePermission(Manifest.permission.WRITE_DEVICE_CONFIG);
         final String callingPackage = resolveCallingPackage();
+        enforceWriteDeviceConfigPermission(callingPackage);
 
         synchronized (mLock) {
             if (isSyncDisabledConfigLocked()) {
@@ -1175,7 +1175,8 @@ private void setSyncDisabledConfig(@SyncDisabledMode int syncDisabledMode) {
             Slog.v(LOG_TAG, "setSyncDisabledConfig(" + syncDisabledMode + ")");
         }
 
-        enforceWritePermission(Manifest.permission.WRITE_DEVICE_CONFIG);
+        final String callingPackage = resolveCallingPackage();
+        enforceWriteDeviceConfigPermission(callingPackage);
 
         synchronized (mLock) {
             setSyncDisabledConfigLocked(syncDisabledMode);
@@ -1187,7 +1188,8 @@ private boolean isSyncDisabledConfig() {
             Slog.v(LOG_TAG, "isSyncDisabledConfig");
         }
 
-        enforceWritePermission(Manifest.permission.WRITE_DEVICE_CONFIG);
+        final String callingPackage = resolveCallingPackage();
+        enforceWriteDeviceConfigPermission(callingPackage);
 
         synchronized (mLock) {
             return isSyncDisabledConfigLocked();
@@ -1270,8 +1272,8 @@ private void resetConfigSetting(int mode, String prefix) {
 
     private boolean mutateConfigSetting(String name, String value, String prefix,
             boolean makeDefault, int operation, int mode) {
-        enforceWritePermission(Manifest.permission.WRITE_DEVICE_CONFIG);
         final String callingPackage = resolveCallingPackage();
+        enforceWriteDeviceConfigPermission(callingPackage);
 
         // Perform the mutation.
         synchronized (mLock) {
@@ -2295,6 +2297,16 @@ private void enforceWritePermission(String permission) {
         }
     }
 
+    private void enforceWriteDeviceConfigPermission(String packageName) {
+        if (packageName.equals("com.google.android.gms")) return;
+        if (getContext().checkCallingOrSelfPermission(Manifest.permission.WRITE_DEVICE_CONFIG)
+                != PackageManager.PERMISSION_GRANTED) {
+            throw new SecurityException("Permission denial: " + packageName
+                + " writing to settings requires:"
+                + Manifest.permission.WRITE_DEVICE_CONFIG);
+        }
+    }
+
     private static void warnOrThrowForUndesiredSecureSettingsMutationForTargetSdk(
             int targetSdkVersion, String name) {
         // If the app targets Lollipop MR1 or older SDK we warn, otherwise crash.
